<!DOCTYPE html>
<html>
<head>
    <title>RAG Sample APP</title>
    <style>
        h2 {
            font-family: Arial, Helvetica, sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h2>Upload a file</h2>
    <form id="uploadForm">
        <input type="file" id="fileInput" name="file" required>
        <button type="submit" id="uploadButton">Upload</button>
        <div id="uploadLoader" class="loader hidden"></div>
    </form>
    <div id="result"></div>
    <script>
        document.getElementById('uploadForm').onsubmit = async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const uploadButton = document.getElementById('uploadButton');
            const uploadLoader = document.getElementById('uploadLoader');
            const file = fileInput.files[0];
            if (!file) return;

            // Show loader and disable button
            uploadButton.disabled = true;
            uploadLoader.classList.remove('hidden');

            try {
                // Read file as text
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const text = event.target.result;
                    // Encode text to UTF-8 bytes
                    const encoder = new TextEncoder();
                    const utf8Bytes = encoder.encode(text);

                    // Create a Blob and FormData
                    const blob = new Blob([utf8Bytes], { type: "text/plain" });
                    const formData = new FormData();
                    formData.append('file', blob, file.name);

                    // Send to backend
                    const response = await fetch('/embed', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    document.getElementById('result').innerText = JSON.stringify(result, null, 2);

                    // Hide loader and enable button
                    uploadButton.disabled = false;
                    uploadLoader.classList.add('hidden');
                };
                reader.readAsText(file);
            } catch (error) {
                // Hide loader and enable button on error
                uploadButton.disabled = false;
                uploadLoader.classList.add('hidden');
                document.getElementById('result').innerText = 'Error: ' + error.message;
            }
        };
    </script>

    <h2>Ask a question</h2>
    <form id="queryForm">
        <input type="text" id="queryInput" name="query" required>
        <button type="submit" id="queryButton">Ask</button>
        <div id="queryLoader" class="loader hidden"></div>
    </form>
    <div id="queryResult"></div>
    <script>
        document.getElementById('queryForm').onsubmit = async function(e) {
            e.preventDefault();
            const queryInput = document.getElementById('queryInput');
            const queryButton = document.getElementById('queryButton');
            const queryLoader = document.getElementById('queryLoader');
            const query = queryInput.value;
            if (!query) return;

            // Show loader and disable button
            queryButton.disabled = true;
            queryLoader.classList.remove('hidden');

            try {
                const response = await fetch(`/rag?q=${encodeURIComponent(query)}`);
                const result = await response.json();
                document.getElementById('queryResult').innerText = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('queryResult').innerText = 'Error: ' + error.message;
            } finally {
                // Hide loader and enable button
                queryButton.disabled = false;
                queryLoader.classList.add('hidden');
            }
        };
    </script>
</body>
</html>